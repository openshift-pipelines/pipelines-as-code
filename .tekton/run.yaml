---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: pipelines-as-code-tests
spec:
  pipelineSpec:
    workspaces:
    - name: source
    params:
      - name: repo_url
      - name: revision
    tasks:
      - name: fetchit
        taskRef:
          name: git-clone
        params:
          - name: url
            value: $(params.repo_url)
          - name: revision
            value: $(params.revision)
        workspaces:
          - name: output
            workspace: source    
      - name: check
        runAfter: [fetchit]
        taskSpec:
          workspaces:
          - name: source        
          steps:
            - name: check
              workingdir: $(workspaces.source.path)
              image: gcr.io/tekton-releases/dogfooding/test-runner
              script: |
                make test lint
        workspaces:
          - name: source
            workspace: source    
  params:
    - name: repo_url
      value: {{repo_url}}
    - name: revision
      value: {{revision}}
  workspaces:
  - name: source
    volumeClaimTemplate:
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
            
